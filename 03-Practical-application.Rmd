---
output:
  bookdown::word_document2: default
  bookdown::pdf_document2:
    template: templates/brief_template.tex
  bookdown::html_document2: default
documentclass: book
bibliography: references.bib
editor_options: 
  chunk_output_type: console
---

```{r echo=FALSE}
library(knitr)
```

<!-- Needed for leaving space to the quote, * is for no indentation after title --> 

<!-- \titlespacing*{\chapter}{0pt}{80px}{35pt} -->

# **Practical application** {#chap:practical-app}
\minitoc  <!--this will include a mini table of contents-->

\chaptermark{Practical application}

In this final chapter we are going to describe the practical application on an actuarial dataset of the models described in section \@ref(chap:models). After describing the problem and how the models have been implemented, we will assess their performance and comment the results.


## Data description

### Dataset

```{r, years_at_risk_read, echo = FALSE, cache = FALSE, message = FALSE}
tab_years_at_risk <- read_csv2("data/practical_application/tab_years_at_risk.csv")
```

The dataset used is an actuarial dataset from an Italian MTPL portfolio. In table \@ref(tab:years-at-risk) the total exposure of the dataset is reported. In the dataset there are `r tab_years_at_risk$n` rows for a total of `r round(tab_years_at_risk$rischi_anno, 1)` years-at-risk. In the dataset, every row is a couple (policy, accounting year), so, if a policy spans in two years, we will see two rows corresponding to that policy. On average, every row has exposure `r round(tab_years_at_risk$durata_media, 3)` years-at-risk. This number is slightly lower than 0.5 because some of the policies get suspended and span in more than two years.

```{r, years_at_risk_render, echo = FALSE, cache = FALSE, message = FALSE}
tab_years_at_risk %>% 
  rename(
    Observations = n,
    `Exposure (Y.a.R.)` = rischi_anno,
    `\\makecell[c]{Average Exposure\\\\per Observation}` = durata_media
  ) %>% 
  kable(
    digits = c(0, 1, 3),
    format.args = list(big.mark = " "),
    # format = "latex",
    booktabs = T,
    align = "ccc",
    vline = "",
    toprule = "\\toprule", midrule = "\\toprule\\addlinespace",
    linesep = "\\addlinespace\\hline\\addlinespace", bottomrule = "\\bottomrule",
    caption = "Total dataset exposure. The exposure is measured in year-at-risk (Y.a.R)",
    label = "years-at-risk",
    escape = FALSE
  ) %>% 
  kable_styling(
    position = "center",
    latex_options = "hold_position",
    full_width = FALSE
  ) %>% 
  row_spec(ifelse(!knitr::is_latex_output(), 0, 1), bold = T)
```


The data comes from the policies of a province in the period 2014-2019. The fact that the policies comes from one specific province reduces a lot the size of the dataset. As the models has been run locally on a single computer, this significantly reduces the time spent to run the models. From a modeling point of view, the reduction to only one province reduces the importance of the geography in the models. Indeed, between the different regions of Italy there are a lot of differences from a socio-economical point of view that are reflected to the claims experience. In this thesis the problem of using geographical data as explanatory variables has not been faced.


```{r, description_train_test_read, echo = FALSE, cache = FALSE, message = FALSE}
tab_freq_sin_train_test <- read_csv2(
  "data/practical_application/tab_freq_sin_train_test.csv"
)

tab_1 <- tab_freq_sin_train_test %>% 
  select(
    set, n, rischi_anno, n_clienti, rischi_anno_per_cliente
  ) %>% 
  mutate(set = str_to_title(set)) %>%
  rename(
    Set = set,
    Observations = n,
    `Exposure (Y.a.R.)` = rischi_anno,
    `Policyholders` = n_clienti,
    `\\makecell[c]{Exposure per\\\\Policyholder}` = rischi_anno_per_cliente,
  ) 


tab_2 <- tab_freq_sin_train_test %>% 
  select(
    set, n, rischi_anno, numero_causati, freq_sin
  ) %>% 
  mutate(set = str_to_title(set)) %>%
  rename(
    Set = set,
    Observations = n,
    `Exposure (Y.a.R.)` = rischi_anno,
    `Claims N.` = numero_causati,
    `Claims Freq.` = freq_sin
  )

# For compatibility with HTML
if(!knitr::is_latex_output()){
  names(tab_1) <- names(tab_1) %>% 
    str_replace_all("\\\\makecell\\[[lrc]\\]\\{(.*)\\}", "\\1") %>% 
    str_replace_all("\\\\\\\\", "<br>")
  
  names(tab_2) <- names(tab_2) %>% 
    str_replace_all("\\\\makecell\\[[lrc]\\]\\{(.*)\\}", "\\1") %>% 
    str_replace_all("\\\\\\\\", "<br>")
}
```

The dataset has been split into a training set with 80% of the observations and a test set with the remaining 20% of the observations. The training set has been used to fit the models, while the test set has been be used to assess them by comparing the predictions of the models with the observed data. The splitting has been made on the base of the policyholder id. That means that policies from the same policyholder end in the same set. This splitting prevents data leakage from the test set to the training set. Table \@ref(tab:exposure-train-test) shows the exposure and the number of policyholders in the training set and the test set. As we can see, on average, each policyholder has more or less `r round(sum(tab_freq_sin_train_test$rischi_anno) / sum(tab_freq_sin_train_test$n_clienti), 1)` years-at-risk.


```{r, description_train_test_render_1, echo = FALSE, cache = FALSE, message = FALSE}

tab_1 %>% 
  kable(
    digits = c(0, 0, 1, 0, 2),
    format.args = list(big.mark = " "),
    # format = "latex",
    booktabs = T,
    align = "lcccc",
    vline = "",
    toprule = "\\toprule", midrule = "\\toprule\\addlinespace",
    linesep = "\\addlinespace\\hline\\addlinespace", bottomrule = "\\bottomrule",
    caption = "Exposure and number of policyholders in training and test set. The exposure is measured in year-at-risk (Y.a.R)",
    label = "exposure-train-test",
    escape = FALSE
  ) %>% 
  kable_styling(
    position = "center",
    latex_options = "hold_position",
    full_width = FALSE
  ) %>% 
  row_spec(ifelse(!knitr::is_latex_output(), 0, 1), bold = T)

```

### Response variable

The response variable for the models is the number of claims caused by the policyholder for that policy in that accounting year. In this project we compared the different techniques in predicting the claims frequency. We didn't take into account the claim severity and we didn't split the claims by typology.

Table \@ref(tab:freq-sin-train-test) shows observed claims frequency in the training set and in the test set. As we can see, the claims frequency in the training set is slightly higher than the claims frequency in the test set. The difference between the two sets is given by chance, but it is also encouraged by the fact that the policies has been split by policyholder id and not by policy. That means that, if a policyholder has many policies, all of them fall into the same set, so the hypothesis of independence for the observations within the sets is not respected. Anyway this issue is restrained and in this analysis has been neglected, as it is usually done in actuarial practice. We also mention that theoretically the difference in claims frequency in the two sets should be mostly explained by the explanatory variables we have, so the models fitted with the training set should be able to catch the characteristics of the policies of the test set that reduces their expected claims frequency.

```{r, description_train_test_render_2, echo = FALSE, cache = FALSE, message = FALSE}
tab_2 %>% 
  kable(
    digits = c(0, 0, 1, 0, 3),
    format.args = list(big.mark = " "),
    # format = "latex",
    booktabs = T,
    align = "lcccc",
    vline = "",
    toprule = "\\toprule", midrule = "\\toprule\\addlinespace",
    linesep = "\\addlinespace\\hline\\addlinespace", bottomrule = "\\bottomrule",
    caption = "Claims Frequency in training and test set.",
    label = "freq-sin-train-test",
    escape = FALSE
  ) %>% 
  kable_styling(
    position = "center",
    latex_options = "hold_position",
    full_width = FALSE
  ) %>% 
  row_spec(ifelse(!knitr::is_latex_output(), 0, 1), bold = T)

```

As we mentioned in section \@ref(chap:model-fitting-and-data-available), the claims settlement is a long process and the response variable we use for fitting the models depends on the moment in which the claims are observed. Indeed it is possible that part of the claims we are considering as response variables will be closed as null-claims and it is possible that there are claims occurred in the period of exposure considered that are not yet reported (IBNyR) at the moment in which the claims have been observed. This phenomenon is more relevant if the period of exposure is close to the moment of observation of the claims.

The claims reported in the dataset are all observed at the date 30/06/2020. In figure \@ref(fig:freq-sin-train-test-year) the claims frequency for each year in the training set and in the test set is reported. The same data is reported in table \@ref(tab:freq-sin-train-test-year). As we can see the years 2017, 2018 and 2019 present a claims frequency lower than the years 2014, 2015 and 2018, so it looks like there is a structure in the claims frequency over the years. Unfortunately, from this data we can't say whether this is due to the different settlement of the claims over the years, to a different mix of policies or just a overall claims trend in the whole market. Anyway, looking to the confidence intervals we realize that this is not a big issue as the effect of the year is not too heavy. Comparing the claims frequency of the training set and the test set, we see that the claims frequency in the test set is consistently lower than the claims frequency in the training set. This phenomenon can be explained with the fact that we divided the policies based on policyholder id, so the policies within each set are correlated.




```{r, freq-sin-train-test-year-read, echo = FALSE, cache = FALSE, message = FALSE}
tab_freq_sin_train_test_year <- read_csv2(
  "data/practical_application/tab_freq_sin_train_test_year.csv"
)
```


(ref:freq-sin-train-test-year-plot-caption) Claims frequency in training and test set in the different years. The semi-transparent ribbons represent 95% confidence intervals for the claims frequency in each year.

(ref:freq-sin-train-test-year-plot-caption-short) Claims frequency in training and test set in the different years.

```{r, freq-sin-train-test-year-plot, out.width = "100%", fig.width = 9, fig.height = 4, fig.align='center', fig.cap = "(ref:freq-sin-train-test-year-plot-caption)", fig.scap = "(ref:freq-sin-train-test-year-plot-caption-short)", label = "freq-sin-train-test-year", echo = FALSE, cache = FALSE}
tab_freq_sin_train_test_year %>% 
  mutate(
    anno_analisi = factor(anno_analisi),
    set = fct_inorder(set)
  ) %>%
  ggplot(aes(x = anno_analisi, y = freq_sin, color = set, fill = set, group = set)) +
  facet_wrap(~set) +
  geom_line() +
  geom_point() +
  geom_ribbon(aes(ymin = down, ymax = up),
              alpha = .2) +
  labs(x = "Accounting Year", y = "Claims Frequency") +
  easy_remove_legend()
```

```{r, freq-sin-train-test-year-render, echo = FALSE, cache = FALSE, message = FALSE}
tab_freq_sin_train_test_year %>% 
  select(set, anno_analisi, freq_sin) %>% 
  pivot_wider(
    names_from = anno_analisi,
    values_from = freq_sin
  ) %>% 
  rename(Set = set) %>% 
  kable(
    digits = c(0, 3, 3, 3, 3, 3, 3),
    format.args = list(big.mark = " "),
    # format = "latex",
    booktabs = T,
    align = "lcccccc",
    vline = "",
    toprule = "\\toprule", midrule = "\\toprule\\addlinespace",
    linesep = "\\addlinespace\\hline\\addlinespace", bottomrule = "\\bottomrule",
    caption = "Claims frequency in training and test set in the different years.",
    label = "freq-sin-train-test-year",
    escape = FALSE
  ) %>% 
  kable_styling(
    position = "center",
    latex_options = "hold_position",
    full_width = FALSE
  ) %>% 
  row_spec(ifelse(!knitr::is_latex_output(), 0, 1), bold = T)

```



### Explanatory variables

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus id mauris interdum, malesuada ante eu, tempus lacus. Aliquam blandit tortor a velit ultricies, eget pharetra nulla egestas. Suspendisse pellentesque finibus est, vitae ullamcorper magna convallis ut. Nulla a lectus in ligula iaculis convallis. Pellentesque tortor mauris, tempor nec dictum et, facilisis sit amet dolor. Mauris nibh quam, molestie non ex quis, hendrerit dignissim nulla. Aliquam sit amet dui at diam vestibulum malesuada a id lacus. Phasellus viverra orci vitae sem pretium, eu consequat libero euismod.





\newpage

## Model used

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus id mauris interdum, malesuada ante eu, tempus lacus. Aliquam blandit tortor a velit ultricies, eget pharetra nulla egestas. Suspendisse pellentesque finibus est, vitae ullamcorper magna convallis ut. Nulla a lectus in ligula iaculis convallis. Pellentesque tortor mauris, tempor nec dictum et, facilisis sit amet dolor. Mauris nibh quam, molestie non ex quis, hendrerit dignissim nulla. Aliquam sit amet dui at diam vestibulum malesuada a id lacus. Phasellus viverra orci vitae sem pretium, eu consequat libero euismod.

Cras suscipit aliquam consequat. Quisque sodales lacus ac erat malesuada, eu laoreet enim vestibulum. Sed id ante id ligula auctor ullamcorper. Sed luctus rutrum mollis. Vestibulum sed ultrices quam. Duis id orci ut enim elementum maximus id quis justo. Pellentesque rutrum ligula in aliquam rhoncus. Integer suscipit nisl at mi efficitur interdum. Aenean et orci elit.

Nam ultricies est et iaculis tempus. Quisque leo lorem, sagittis et ligula a, blandit mattis velit. Phasellus pretium, orci et semper finibus, dui nulla tempor nisl, vel vehicula magna diam nec sem. Praesent finibus commodo enim non laoreet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ut pellentesque purus. Proin hendrerit, odio vel sodales porta, ex lorem feugiat sem, non fringilla libero ex ac ligula. Quisque facilisis eros at suscipit rhoncus.


## Model assessment

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus id mauris interdum, malesuada ante eu, tempus lacus. Aliquam blandit tortor a velit ultricies, eget pharetra nulla egestas. Suspendisse pellentesque finibus est, vitae ullamcorper magna convallis ut. Nulla a lectus in ligula iaculis convallis. Pellentesque tortor mauris, tempor nec dictum et, facilisis sit amet dolor. Mauris nibh quam, molestie non ex quis, hendrerit dignissim nulla. Aliquam sit amet dui at diam vestibulum malesuada a id lacus. Phasellus viverra orci vitae sem pretium, eu consequat libero euismod.

Cras suscipit aliquam consequat. Quisque sodales lacus ac erat malesuada, eu laoreet enim vestibulum. Sed id ante id ligula auctor ullamcorper. Sed luctus rutrum mollis. Vestibulum sed ultrices quam. Duis id orci ut enim elementum maximus id quis justo. Pellentesque rutrum ligula in aliquam rhoncus. Integer suscipit nisl at mi efficitur interdum. Aenean et orci elit.

Nam ultricies est et iaculis tempus. Quisque leo lorem, sagittis et ligula a, blandit mattis velit. Phasellus pretium, orci et semper finibus, dui nulla tempor nisl, vel vehicula magna diam nec sem. Praesent finibus commodo enim non laoreet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ut pellentesque purus. Proin hendrerit, odio vel sodales porta, ex lorem feugiat sem, non fringilla libero ex ac ligula. Quisque facilisis eros at suscipit rhoncus.


## Results

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus id mauris interdum, malesuada ante eu, tempus lacus. Aliquam blandit tortor a velit ultricies, eget pharetra nulla egestas. Suspendisse pellentesque finibus est, vitae ullamcorper magna convallis ut. Nulla a lectus in ligula iaculis convallis. Pellentesque tortor mauris, tempor nec dictum et, facilisis sit amet dolor. Mauris nibh quam, molestie non ex quis, hendrerit dignissim nulla. Aliquam sit amet dui at diam vestibulum malesuada a id lacus. Phasellus viverra orci vitae sem pretium, eu consequat libero euismod.

Cras suscipit aliquam consequat. Quisque sodales lacus ac erat malesuada, eu laoreet enim vestibulum. Sed id ante id ligula auctor ullamcorper. Sed luctus rutrum mollis. Vestibulum sed ultrices quam. Duis id orci ut enim elementum maximus id quis justo. Pellentesque rutrum ligula in aliquam rhoncus. Integer suscipit nisl at mi efficitur interdum. Aenean et orci elit.

Nam ultricies est et iaculis tempus. Quisque leo lorem, sagittis et ligula a, blandit mattis velit. Phasellus pretium, orci et semper finibus, dui nulla tempor nisl, vel vehicula magna diam nec sem. Praesent finibus commodo enim non laoreet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur ut pellentesque purus. Proin hendrerit, odio vel sodales porta, ex lorem feugiat sem, non fringilla libero ex ac ligula. Quisque facilisis eros at suscipit rhoncus.

<!-- \titlespacing{\chapter}{0pt}{0pt}{35pt} -->

